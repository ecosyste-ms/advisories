require "test_helper"

class Osv::VulnerabilityTransformerTest < ActiveSupport::TestCase
  setup do
    @source = create(:source)
    @advisory = create(:advisory,
      source: @source,
      uuid: "GHSA-xxxx-yyyy-zzzz",
      title: "Test Vulnerability",
      description: "A test vulnerability description",
      identifiers: ["GHSA-xxxx-yyyy-zzzz", "CVE-2023-12345"],
      cvss_vector: "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
      cvss_score: 9.8,
      severity: "critical",
      references: ["https://github.com/example/advisory", "https://nvd.nist.gov/vuln/detail/CVE-2023-12345"],
      packages: [
        {
          "ecosystem" => "npm",
          "package_name" => "lodash",
          "versions" => [
            { "vulnerable_version_range" => ">= 1.0.0, < 4.17.21", "first_patched_version" => "4.17.21" }
          ]
        }
      ],
      published_at: Time.zone.parse("2023-01-15 10:00:00 UTC"),
      withdrawn_at: nil
    )
  end

  test "transforms advisory to full OSV format" do
    transformer = Osv::VulnerabilityTransformer.new(@advisory)
    result = transformer.transform

    assert_equal "GHSA-xxxx-yyyy-zzzz", result[:id]
    assert_equal "Test Vulnerability", result[:summary]
    assert_equal "A test vulnerability description", result[:details]
    assert_includes result[:aliases], "CVE-2023-12345"
    refute_includes result[:aliases], "GHSA-xxxx-yyyy-zzzz"
    assert_not_nil result[:modified]
    assert_not_nil result[:published]
    refute_includes result.keys, :withdrawn
  end

  test "transforms advisory to summary format" do
    transformer = Osv::VulnerabilityTransformer.new(@advisory)
    result = transformer.transform(summary_only: true)

    assert_equal "GHSA-xxxx-yyyy-zzzz", result[:id]
    assert_not_nil result[:modified]
    assert_equal 2, result.keys.count
  end

  test "truncates long titles to 120 characters" do
    @advisory.update!(title: "A" * 200)
    transformer = Osv::VulnerabilityTransformer.new(@advisory)
    result = transformer.transform

    assert_equal 120, result[:summary].length
    assert result[:summary].end_with?("...")
  end

  test "maps npm ecosystem correctly" do
    transformer = Osv::VulnerabilityTransformer.new(@advisory)
    result = transformer.transform

    assert_equal "npm", result[:affected].first[:package][:ecosystem]
  end

  test "maps pypi ecosystem to PyPI" do
    @advisory.update!(packages: [{ "ecosystem" => "pypi", "package_name" => "django", "versions" => [] }])
    transformer = Osv::VulnerabilityTransformer.new(@advisory)
    result = transformer.transform

    assert_equal "PyPI", result[:affected].first[:package][:ecosystem]
  end

  test "maps rubygems ecosystem to RubyGems" do
    @advisory.update!(packages: [{ "ecosystem" => "rubygems", "package_name" => "rails", "versions" => [] }])
    transformer = Osv::VulnerabilityTransformer.new(@advisory)
    result = transformer.transform

    assert_equal "RubyGems", result[:affected].first[:package][:ecosystem]
  end

  test "maps go ecosystem correctly" do
    @advisory.update!(packages: [{ "ecosystem" => "go", "package_name" => "golang.org/x/net", "versions" => [] }])
    transformer = Osv::VulnerabilityTransformer.new(@advisory)
    result = transformer.transform

    assert_equal "Go", result[:affected].first[:package][:ecosystem]
  end

  test "maps cargo ecosystem to crates.io" do
    @advisory.update!(packages: [{ "ecosystem" => "cargo", "package_name" => "serde", "versions" => [] }])
    transformer = Osv::VulnerabilityTransformer.new(@advisory)
    result = transformer.transform

    assert_equal "crates.io", result[:affected].first[:package][:ecosystem]
  end

  test "maps maven ecosystem to Maven" do
    @advisory.update!(packages: [{ "ecosystem" => "maven", "package_name" => "org.apache.log4j:log4j-core", "versions" => [] }])
    transformer = Osv::VulnerabilityTransformer.new(@advisory)
    result = transformer.transform

    assert_equal "Maven", result[:affected].first[:package][:ecosystem]
  end

  test "maps nuget ecosystem to NuGet" do
    @advisory.update!(packages: [{ "ecosystem" => "nuget", "package_name" => "Newtonsoft.Json", "versions" => [] }])
    transformer = Osv::VulnerabilityTransformer.new(@advisory)
    result = transformer.transform

    assert_equal "NuGet", result[:affected].first[:package][:ecosystem]
  end

  test "includes CVSS v3 severity" do
    transformer = Osv::VulnerabilityTransformer.new(@advisory)
    result = transformer.transform

    assert_equal 1, result[:severity].length
    assert_equal "CVSS_V3", result[:severity].first[:type]
    assert_equal @advisory.cvss_vector, result[:severity].first[:score]
  end

  test "detects CVSS v4 vectors" do
    @advisory.update!(cvss_vector: "CVSS:4.0/AV:N/AC:L/AT:N/PR:N/UI:N/VC:H/VI:H/VA:H/SC:N/SI:N/SA:N")
    transformer = Osv::VulnerabilityTransformer.new(@advisory)
    result = transformer.transform

    assert_equal "CVSS_V4", result[:severity].first[:type]
  end

  test "excludes severity when cvss_vector is nil" do
    @advisory.update!(cvss_vector: nil)
    transformer = Osv::VulnerabilityTransformer.new(@advisory)
    result = transformer.transform

    refute_includes result.keys, :severity
  end

  test "includes withdrawn timestamp when present" do
    @advisory.update!(withdrawn_at: Time.zone.parse("2023-06-01 12:00:00 UTC"))
    transformer = Osv::VulnerabilityTransformer.new(@advisory)
    result = transformer.transform

    assert_includes result.keys, :withdrawn
    assert_equal "2023-06-01T12:00:00Z", result[:withdrawn]
  end

  test "parses version range with >= and <" do
    transformer = Osv::VulnerabilityTransformer.new(@advisory)
    result = transformer.transform

    ranges = result[:affected].first[:ranges]
    assert_equal 1, ranges.length
    assert_equal "ECOSYSTEM", ranges.first[:type]

    events = ranges.first[:events]
    assert events.any? { |e| e[:introduced] == "1.0.0" }
    assert events.any? { |e| e[:fixed] == "4.17.21" }
  end

  test "parses simple < version range" do
    @advisory.update!(packages: [
      {
        "ecosystem" => "npm",
        "package_name" => "test",
        "versions" => [{ "vulnerable_version_range" => "< 2.0.0" }]
      }
    ])
    transformer = Osv::VulnerabilityTransformer.new(@advisory)
    result = transformer.transform

    events = result[:affected].first[:ranges].first[:events]
    assert events.any? { |e| e[:introduced] == "0" }
    assert events.any? { |e| e[:fixed] == "2.0.0" }
  end

  test "parses >= only version range" do
    @advisory.update!(packages: [
      {
        "ecosystem" => "npm",
        "package_name" => "test",
        "versions" => [{ "vulnerable_version_range" => ">= 1.0.0" }]
      }
    ])
    transformer = Osv::VulnerabilityTransformer.new(@advisory)
    result = transformer.transform

    events = result[:affected].first[:ranges].first[:events]
    assert events.any? { |e| e[:introduced] == "1.0.0" }
    refute events.any? { |e| e.key?(:fixed) }
  end

  test "uses first_patched_version when no fixed in range" do
    @advisory.update!(packages: [
      {
        "ecosystem" => "npm",
        "package_name" => "test",
        "versions" => [{ "vulnerable_version_range" => ">= 1.0.0", "first_patched_version" => "1.5.0" }]
      }
    ])
    transformer = Osv::VulnerabilityTransformer.new(@advisory)
    result = transformer.transform

    events = result[:affected].first[:ranges].first[:events]
    assert events.any? { |e| e[:fixed] == "1.5.0" }
  end

  test "builds references with inferred types" do
    @advisory.update!(references: [
      "https://github.com/example/advisory",
      "https://nvd.nist.gov/vuln/detail/CVE-2023-12345",
      "https://github.com/example/repo/commit/abc123",
      "https://example.com/info"
    ])
    transformer = Osv::VulnerabilityTransformer.new(@advisory)
    result = transformer.transform

    refs = result[:references]
    assert_equal 4, refs.length
    assert refs.any? { |r| r[:type] == "ADVISORY" && r[:url].include?("advisory") }
    assert refs.any? { |r| r[:type] == "ADVISORY" && r[:url].include?("nvd.nist.gov") }
    assert refs.any? { |r| r[:type] == "FIX" && r[:url].include?("commit") }
    assert refs.any? { |r| r[:type] == "WEB" && r[:url] == "https://example.com/info" }
  end

  test "builds database_specific with extra fields" do
    @advisory.update!(url: "https://example.com/advisory/123", source_kind: "github")
    transformer = Osv::VulnerabilityTransformer.new(@advisory)
    result = transformer.transform

    db_specific = result[:database_specific]
    assert_equal "github", db_specific[:source]
    assert_equal "https://example.com/advisory/123", db_specific[:url]
    assert_equal @advisory.severity, db_specific[:severity]
    assert_equal @advisory.cvss_score, db_specific[:cvss_score]
  end

  test "excludes uuid from aliases" do
    transformer = Osv::VulnerabilityTransformer.new(@advisory)
    result = transformer.transform

    refute_includes result[:aliases], @advisory.uuid
    assert_includes result[:aliases], "CVE-2023-12345"
  end

  test "handles advisory with no packages" do
    @advisory.update!(packages: [])
    transformer = Osv::VulnerabilityTransformer.new(@advisory)
    result = transformer.transform

    assert_equal [], result[:affected]
  end

  test "handles advisory with empty versions" do
    @advisory.update!(packages: [{ "ecosystem" => "npm", "package_name" => "test", "versions" => [] }])
    transformer = Osv::VulnerabilityTransformer.new(@advisory)
    result = transformer.transform

    assert_equal [], result[:affected].first[:ranges]
  end

  test "formats timestamps in ISO 8601 UTC" do
    transformer = Osv::VulnerabilityTransformer.new(@advisory)
    result = transformer.transform

    assert_match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}Z$/, result[:published])
    assert_match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}Z$/, result[:modified])
  end

  test "preserves unknown ecosystem names" do
    @advisory.update!(packages: [{ "ecosystem" => "unknown_ecosystem", "package_name" => "test", "versions" => [] }])
    transformer = Osv::VulnerabilityTransformer.new(@advisory)
    result = transformer.transform

    assert_equal "unknown_ecosystem", result[:affected].first[:package][:ecosystem]
  end
end
